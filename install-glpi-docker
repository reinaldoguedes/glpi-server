!/bin/bash
clear
echo "###################################################################"
echo "#                                                                 #"
echo "#      - Sistema de Instalação dp Glpi em Cluster Docker  -       #"
echo "#                                                                 #"
echo "#              Desenvolvido por CNSoltuions - LTDA                #"
echo "#                                                                 #"
echo "#         e-mail: reinaldoguedes@cnsolutions.com.br               #"
echo "#                                                                 #"
echo "###################################################################"
echo ""
echo " -* Preparando o Sistema para receber o Cluster GLPI *-"
echo ""
sleep 5
clear
echo "Atualizando a base e a estrutura do sistema operacional"
echo ""
sudo apt-get update -y && apt-get upgrade -y
echo ""
sleep 3
clear
echo "Instalando o docker"
echo ""
sudo curl -fsSL https://get.docker.com/ | sh
echo ""
sleep 3
clear
echo "Testando o docker"
echo ""
sudo docker run hello-world
echo ""
sleep 3
clear
echo "Instalando o docker compose"
echo ""
sudo apt-get install docker-compose -y
echo ""
sleep 3
clear
echo "Inicializando o swarm do docker"
echo ""
sudo docker swarm init
sleep 3
echo ""
sleep 3
clear
echo "Criando Volumes do Container Webdir"
echo ""
sudo docker volume create glpi_webdir
echo ""
sleep 5
clear
echo " -* Iniciando as etapas da criação do cluster *-"
echo ""
echo "Fazendo download da aplicação do glpi 11.0.1"
echo ""
wget https://github.com/glpi-project/glpi/releases/download/11.0.1/glpi-11.0.1.tgz
echo ""
echo "Extraindo arquivos da Aplicação"
tar -xzvf ~/glpi-server/glpi*.tgz
sudo  ~/glpi-server/glpi/* /var/lib/docker/volumes/glpi_webdir/_data/.
echo ""
echo "Aplicando permissões necessarias"
echo ""
sudo chmod -R  777 /var/lib/docker/volumes/glpi_webdir/_data/config/
sudo chmod -R  777 /var/lib/docker/volumes/glpi_webdir/_data/files/
sudo chmod -R  777 /var/lib/docker/volumes/glpi_webdir/_data/marketplace/
sudo m -rf ~/glpi-server/glpi*
cd ~/glpi-server/
echo "Criando as imagens cluster GLPI - MYSQL - PHPADMIN"
echo ""
sudo docker-compose build
echo ""
sleep 3
clear
echo "Criando o Cluster GLPI"
echo ""
sudo docker stack deploy --compose-file ~/glpi-server/docker-compose.yml glpi
echo ""
echo "Acessar a pagina do IP do servidor e configurar a interface Web"
echo
